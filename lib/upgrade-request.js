"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.__test__ = undefined;

exports.default = function (options) {
    let LOG = options.logger;
    let yarnpkg = new _yarnpkg2.default(options.workingdir, LOG);
    let git = new _git2.default(options.workingdir, LOG);
    return yarnpkg.install().then(() => yarnpkg.outdated()).then(out => findOutdatedDeps(LOG, out)).then(([diff, hex]) => git.fetch("origin").then(() => [diff, hex])).then(([diff, hex]) => git.branchList().then(names => [names, diff, hex])).then(([names, diff, hex]) => findExistingBranch(LOG, options, names, diff, hex)).then(([newBranch, diff]) => git.checkoutWith(newBranch).then(() => diff)).then(diff => collectModuleVersions(options).then(mv => [mv, diff])).then(([mv, diff]) => yarnpkg.upgrade(options.latest).then(out => computeUpdatedDependencies(LOG, options, diff, mv, out))).then(diff => git.setup(options.username, options.useremail).then(() => [diff, options])).then(([diff, options]) => addTargetFiles(LOG, options, git).then(() => diff)).then(diff => git.commit("update dependencies").then(() => diff)).then(diff => git.currentBranch().then(newBranch => [newBranch, diff])).then(([newBranch, diff]) => git.checkout("-").then(() => [newBranch, diff])).then(([newBranch, diff]) => git.currentBranch().then(baseBranch => [baseBranch, newBranch, diff])).then(([baseBranch, newBranch, diff]) => selectPushPromise(LOG, options, git, "origin", newBranch).then(() => [baseBranch, newBranch, diff])).then(([baseBranch, newBranch, diff]) => git.remoteurl("origin").then(remote => {
        if (options.bitbucket) {
            return [new _bitBucket2.default(options, remote), baseBranch, newBranch, diff];
        } else {
            return [new _github2.default(options, remote), baseBranch, newBranch, diff];
        }
    })).then(([github, baseBranch, newBranch, diff]) => github.pullRequest(baseBranch, newBranch, diff).then(report => [report, newBranch])).then(([report, newBranch]) => selectDeletePromise(LOG, options, git, newBranch, report));
};

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _sha = require("sha.js");

var _sha2 = _interopRequireDefault(_sha);

var _fs = require("mz/fs");

var _fs2 = _interopRequireDefault(_fs);

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _yarnpkg = require("./yarnpkg");

var _yarnpkg2 = _interopRequireDefault(_yarnpkg);

var _git = require("./git");

var _git2 = _interopRequireDefault(_git);

var _github = require("./github");

var _github2 = _interopRequireDefault(_github);

var _bitBucket = require("./bitBucket");

var _bitBucket2 = _interopRequireDefault(_bitBucket);

var _readPackageJson = require("./promise/read-package-json");

var _readPackageJson2 = _interopRequireDefault(_readPackageJson);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function findOutdatedDeps(LOG, out) {
    LOG("Find some outdated dependencies.");
    LOG(`all of output ${out}`);
    let json = _lodash2.default.last(out.split(/\r?\n/)); // skip Color legend
    LOG(`difference table ${json}`);
    if (json) {
        let diff = JSON.parse(json).data.body;
        if (diff && diff.some(v => v[1] !== v[2])) {
            LOG("Found outdated dependencies.");
            let hex = new _sha2.default.sha1().update(json, "utf8").digest("hex");
            return [diff, hex];
        }
    }
    LOG("Did not find outdated dependencies.");
    return Promise.reject("dependencies are up to date.");
}

function collectModuleVersions(options) {
    if (options.withShadows) {
        let modules = _path2.default.join(options.workingdir, "node_modules");
        return _fs2.default.readdir(modules).then(files => {
            let ps = files.map(n => _path2.default.join(modules, n)).map(n => [n, _fs2.default.statSync(n)]).filter(v => v[1].isDirectory()).map(v => _path2.default.join(v[0], "package.json")).map(n => [n, _fs2.default.existsSync(n)]).filter(v => v[1]).map(v => (0, _readPackageJson2.default)(v[0]));
            return Promise.all(ps).then(pkgs => {
                return new Map(pkgs.map(pkg => [pkg.name, pkg.version]));
            });
        });
    }
    return Promise.resolve(new Map());
}

function computeUpdatedDependencies(LOG, options, diff, mv, out) {
    LOG("compute shadow dependencies");
    if (options.withShadows) {
        let msgs = out.split(/[\r]?\n/);
        let tree = JSON.parse(msgs[msgs.length - 1]);

        let names = new Set(diff.map(d => d[0]));
        let shadows = tree.data.trees.map(v => v.name.split(/@/)).filter(([name, version]) => {
            let cur = mv.get(name);
            return cur ? cur !== version : true;
        }).map(([name, version]) => {
            let cur = mv.get(name);
            return [name, cur || version, version, undefined, "shadow"];
        }).filter(v => names.has(v[0]) === false);
        return diff.concat(shadows.sort((left, right) => {
            return left[0].localeCompare(right[0]);
        }));
    }
    return diff;
}

function findExistingBranch(LOG, options, names, diff, hex) {
    LOG("Find existing branch.");
    let newBranch = `${options.prefix}${options.now}/${hex}`;
    let found = names.find(n => n.endsWith(hex));
    if (found) {
        LOG(`Found existing branch ${found}`);
        return Promise.reject("Working Branch is already exists.");
    }
    return [newBranch, diff];
}

function addTargetFiles(LOG, options, git) {
    let targets = [];
    if (options.latest) {
        LOG("Added package.json into request files because --latest is specified.");
        targets.push("package.json");
    }
    targets.push("yarn.lock");
    return targets.reduce((promise, target) => promise.then(() => git.add(target)), Promise.resolve());
}

function selectPushPromise(LOG, options, git, remote, branch) {
    if (options.execute) {
        return git.push(remote, branch);
    }
    LOG("`git push` is skipped because --execute is not specified.");
    return Promise.resolve();
}

function selectDeletePromise(LOG, options, git, branch, report) {
    let p;
    if (options.keep) {
        LOG("Working branch is kept.");
        p = Promise.resolve();
    } else {
        LOG("Delete working branch because --keep is not specified.");
        p = git.deleteBranch(branch);
    }
    return p.then(() => report);
}

// for tesing purpose
const __test__ = exports.__test__ = [findOutdatedDeps, findExistingBranch, addTargetFiles, selectPushPromise, selectDeletePromise];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91cGdyYWRlLXJlcXVlc3QuanMiXSwibmFtZXMiOlsib3B0aW9ucyIsIkxPRyIsImxvZ2dlciIsInlhcm5wa2ciLCJZYXJucGtnIiwid29ya2luZ2RpciIsImdpdCIsIkdpdCIsImluc3RhbGwiLCJ0aGVuIiwib3V0ZGF0ZWQiLCJvdXQiLCJmaW5kT3V0ZGF0ZWREZXBzIiwiZGlmZiIsImhleCIsImZldGNoIiwiYnJhbmNoTGlzdCIsIm5hbWVzIiwiZmluZEV4aXN0aW5nQnJhbmNoIiwibmV3QnJhbmNoIiwiY2hlY2tvdXRXaXRoIiwiY29sbGVjdE1vZHVsZVZlcnNpb25zIiwibXYiLCJ1cGdyYWRlIiwibGF0ZXN0IiwiY29tcHV0ZVVwZGF0ZWREZXBlbmRlbmNpZXMiLCJzZXR1cCIsInVzZXJuYW1lIiwidXNlcmVtYWlsIiwiYWRkVGFyZ2V0RmlsZXMiLCJjb21taXQiLCJjdXJyZW50QnJhbmNoIiwiY2hlY2tvdXQiLCJiYXNlQnJhbmNoIiwic2VsZWN0UHVzaFByb21pc2UiLCJyZW1vdGV1cmwiLCJyZW1vdGUiLCJiaXRidWNrZXQiLCJCaXRCdWNrZXQiLCJHaXRIdWIiLCJnaXRodWIiLCJwdWxsUmVxdWVzdCIsInJlcG9ydCIsInNlbGVjdERlbGV0ZVByb21pc2UiLCJqc29uIiwiXyIsImxhc3QiLCJzcGxpdCIsIkpTT04iLCJwYXJzZSIsImRhdGEiLCJib2R5Iiwic29tZSIsInYiLCJoYXNoIiwic2hhMSIsInVwZGF0ZSIsImRpZ2VzdCIsIlByb21pc2UiLCJyZWplY3QiLCJ3aXRoU2hhZG93cyIsIm1vZHVsZXMiLCJwYXRoIiwiam9pbiIsImZzIiwicmVhZGRpciIsImZpbGVzIiwicHMiLCJtYXAiLCJuIiwic3RhdFN5bmMiLCJmaWx0ZXIiLCJpc0RpcmVjdG9yeSIsImV4aXN0c1N5bmMiLCJhbGwiLCJwa2dzIiwiTWFwIiwicGtnIiwibmFtZSIsInZlcnNpb24iLCJyZXNvbHZlIiwibXNncyIsInRyZWUiLCJsZW5ndGgiLCJTZXQiLCJkIiwic2hhZG93cyIsInRyZWVzIiwiY3VyIiwiZ2V0IiwidW5kZWZpbmVkIiwiaGFzIiwiY29uY2F0Iiwic29ydCIsImxlZnQiLCJyaWdodCIsImxvY2FsZUNvbXBhcmUiLCJwcmVmaXgiLCJub3ciLCJmb3VuZCIsImZpbmQiLCJlbmRzV2l0aCIsInRhcmdldHMiLCJwdXNoIiwicmVkdWNlIiwicHJvbWlzZSIsInRhcmdldCIsImFkZCIsImJyYW5jaCIsImV4ZWN1dGUiLCJwIiwia2VlcCIsImRlbGV0ZUJyYW5jaCIsIl9fdGVzdF9fIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O2tCQXdIZSxVQUFVQSxPQUFWLEVBQW1CO0FBQzlCLFFBQUlDLE1BQU1ELFFBQVFFLE1BQWxCO0FBQ0EsUUFBSUMsVUFBVSxJQUFJQyxpQkFBSixDQUFZSixRQUFRSyxVQUFwQixFQUFnQ0osR0FBaEMsQ0FBZDtBQUNBLFFBQUlLLE1BQU0sSUFBSUMsYUFBSixDQUFRUCxRQUFRSyxVQUFoQixFQUE0QkosR0FBNUIsQ0FBVjtBQUNBLFdBQU9FLFFBQVFLLE9BQVIsR0FDRkMsSUFERSxDQUNHLE1BQU1OLFFBQVFPLFFBQVIsRUFEVCxFQUVGRCxJQUZFLENBRUdFLE9BQU9DLGlCQUFpQlgsR0FBakIsRUFBc0JVLEdBQXRCLENBRlYsRUFHRkYsSUFIRSxDQUdHLENBQUMsQ0FBQ0ksSUFBRCxFQUFPQyxHQUFQLENBQUQsS0FBaUJSLElBQUlTLEtBQUosQ0FBVSxRQUFWLEVBQW9CTixJQUFwQixDQUF5QixNQUFNLENBQUNJLElBQUQsRUFBT0MsR0FBUCxDQUEvQixDQUhwQixFQUlGTCxJQUpFLENBSUcsQ0FBQyxDQUFDSSxJQUFELEVBQU9DLEdBQVAsQ0FBRCxLQUFpQlIsSUFBSVUsVUFBSixHQUFpQlAsSUFBakIsQ0FBc0JRLFNBQVMsQ0FBQ0EsS0FBRCxFQUFRSixJQUFSLEVBQWNDLEdBQWQsQ0FBL0IsQ0FKcEIsRUFLRkwsSUFMRSxDQUtHLENBQUMsQ0FBQ1EsS0FBRCxFQUFRSixJQUFSLEVBQWNDLEdBQWQsQ0FBRCxLQUF3QkksbUJB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Q0FDSCxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUJELFFBQVFoRyxJQUFSLENBQWEsTUFBTUgsSUFBSXFHLEdBQUosQ0FBUUQsTUFBUixDQUFuQixDQURsQixFQUVIaEQsUUFBUXNCLE9BQVIsRUFGRyxDQUFQO0FBSUg7O0FBRUQsU0FBUzlDLGlCQUFULENBQTJCakMsR0FBM0IsRUFBZ0NELE9BQWhDLEVBQXlDTSxHQUF6QyxFQUE4QzhCLE1BQTlDLEVBQXNEd0UsTUFBdEQsRUFBOEQ7QUFDMUQsUUFBSTVHLFFBQVE2RyxPQUFaLEVBQXFCO0FBQ2pCLGVBQU92RyxJQUFJaUcsSUFBSixDQUFTbkUsTUFBVCxFQUFpQndFLE1BQWpCLENBQVA7QUFDSDtBQUNEM0csUUFBSSwyREFBSjtBQUNBLFdBQU95RCxRQUFRc0IsT0FBUixFQUFQO0FBQ0g7O0FBRUQsU0FBU3JDLG1CQUFULENBQTZCMUMsR0FBN0IsRUFBa0NELE9BQWxDLEVBQTJDTSxHQUEzQyxFQUFnRHNHLE1BQWhELEVBQXdEbEUsTUFBeEQsRUFBZ0U7QUFDNUQsUUFBSW9FLENBQUo7QUFDQSxRQUFJOUcsUUFBUStHLElBQVosRUFBa0I7QUFDZDlHLFlBQUkseUJBQUo7QUFDQTZHLFlBQUlwRCxRQUFRc0IsT0FBUixFQUFKO0FBQ0gsS0FIRCxNQUdPO0FBQ0gvRSxZQUFJLHdEQUFKO0FBQ0E2RyxZQUFJeEcsSUFBSTBHLFlBQUosQ0FBaUJKLE1BQWpCLENBQUo7QUFDSDtBQUNELFdBQU9FLEVBQUVyRyxJQUFGLENBQU8sTUFBTWlDLE1BQWIsQ0FBUDtBQUNIOztBQUVEO0FBQ08sTUFBTXVFLDhCQUFXLENBQUNyRyxnQkFBRCxFQUFtQk0sa0JBQW5CLEVBQXVDVyxjQUF2QyxFQUF1REssaUJBQXZELEVBQTBFUyxtQkFBMUUsQ0FBakIiLCJmaWxlIjoidXBncmFkZS1yZXF1ZXN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IGhhc2ggZnJvbSBcInNoYS5qc1wiO1xuaW1wb3J0IGZzIGZyb20gXCJtei9mc1wiO1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcblxuaW1wb3J0IFlhcm5wa2cgZnJvbSBcIi4veWFybnBrZ1wiO1xuaW1wb3J0IEdpdCBmcm9tIFwiLi9naXRcIjtcbmltcG9ydCBHaXRIdWIgZnJvbSBcIi4vZ2l0aHViXCI7XG5pbXBvcnQgQml0QnVja2V0IGZyb20gXCIuL2JpdEJ1Y2tldFwiO1xuaW1wb3J0IHJwaiBmcm9tIFwiLi9wcm9taXNlL3JlYWQtcGFja2FnZS1qc29uXCI7XG5cbmZ1bmN0aW9uIGZpbmRPdXRkYXRlZERlcHMoTE9HLCBvdXQpIHtcbiAgICBMT0coXCJGaW5kIHNvbWUgb3V0ZGF0ZWQgZGVwZW5kZW5jaWVzLlwiKTtcbiAgICBMT0coYGFsbCBvZiBvdXRwdXQgJHtvdXR9YCk7XG4gICAgbGV0IGpzb24gPSBfLmxhc3Qob3V0LnNwbGl0KC9cXHI/XFxuLykpOyAvLyBza2lwIENvbG9yIGxlZ2VuZFxuICAgIExPRyhgZGlmZmVyZW5jZSB0YWJsZSAke2pzb259YCk7XG4gICAgaWYgKGpzb24pIHtcbiAgICAgICAgbGV0IGRpZmYgPSBKU09OLnBhcnNlKGpzb24pLmRhdGEuYm9keTtcbiAgICAgICAgaWYgKGRpZmYgJiYgZGlmZi5zb21lKHYgPT4gdlsxXSAhPT0gdlsyXSkpIHtcbiAgICAgICAgICAgIExPRyhcIkZvdW5kIG91dGRhdGVkIGRlcGVuZGVuY2llcy5cIik7XG4gICAgICAgICAgICBsZXQgaGV4ID0gbmV3IGhhc2guc2hhMSgpLnVwZGF0ZShqc29uLCBcInV0ZjhcIikuZGlnZXN0KFwiaGV4XCIpO1xuICAgICAgICAgICAgcmV0dXJuIFtkaWZmLCBoZXhdO1xuICAgICAgICB9XG4gICAgfVxuICAgIExPRyhcIkRpZCBub3QgZmluZCBvdXRkYXRlZCBkZXBlbmRlbmNpZXMuXCIpO1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChcImRlcGVuZGVuY2llcyBhcmUgdXAgdG8gZGF0ZS5cIik7XG59XG5cbmZ1bmN0aW9uIGNvbGxlY3RNb2R1bGVWZXJzaW9ucyhvcHRpb25zKSB7XG4gICAgaWYgKG9wdGlvbnMud2l0aFNoYWRvd3MpIHtcbiAgICAgICAgbGV0IG1vZHVsZXMgPSBwYXRoLmpvaW4ob3B0aW9ucy53b3JraW5nZGlyLCBcIm5vZGVfbW9kdWxlc1wiKTtcbiAgICAgICAgcmV0dXJuIGZzLnJlYWRkaXIobW9kdWxlcykudGhlbihmaWxlcyA9PiB7XG4gICAgICAgICAgICBsZXQgcHMgPSBmaWxlc1xuICAgICAgICAgICAgICAgIC5tYXAobiA9PiBwYXRoLmpvaW4obW9kdWxlcywgbikpXG4gICAgICAgICAgICAgICAgLm1hcChuID0+IFtuLCBmcy5zdGF0U3luYyhuKV0pXG4gICAgICAgICAgICAgICAgLmZpbHRlcih2ID0+IHZbMV0uaXNEaXJlY3RvcnkoKSlcbiAgICAgICAgICAgICAgICAubWFwKHYgPT4gcGF0aC5qb2luKHZbMF0sIFwicGFja2FnZS5qc29uXCIpKVxuICAgICAgICAgICAgICAgIC5tYXAobiA9PiBbbiwgZnMuZXhpc3RzU3luYyhuKV0pXG4gICAgICAgICAgICAgICAgLmZpbHRlcih2ID0+IHZbMV0pXG4gICAgICAgICAgICAgICAgLm1hcCh2ID0+IHJwaih2WzBdKSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHMpLnRoZW4ocGtncyA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBNYXAocGtncy5tYXAocGtnID0+IFtwa2cubmFtZSwgcGtnLnZlcnNpb25dKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobmV3IE1hcCgpKTtcbn1cblxuZnVuY3Rpb24gY29tcHV0ZVVwZGF0ZWREZXBlbmRlbmNpZXMoTE9HLCBvcHRpb25zLCBkaWZmLCBtdiwgb3V0KSB7XG4gICAgTE9HKFwiY29tcHV0ZSBzaGFkb3cgZGVwZW5kZW5jaWVzXCIpO1xuICAgIGlmIChvcHRpb25zLndpdGhTaGFkb3dzKSB7XG4gICAgICAgIGxldCBtc2dzID0gb3V0LnNwbGl0KC9bXFxyXT9cXG4vKTtcbiAgICAgICAgbGV0IHRyZWUgPSBKU09OLnBhcnNlKG1zZ3NbbXNncy5sZW5ndGggLSAxXSk7XG5cbiAgICAgICAgbGV0IG5hbWVzID0gbmV3IFNldChkaWZmLm1hcChkID0+IGRbMF0pKTtcbiAgICAgICAgbGV0IHNoYWRvd3MgPSB0cmVlLmRhdGEudHJlZXNcbiAgICAgICAgICAgIC5tYXAodiA9PiB2Lm5hbWUuc3BsaXQoL0AvKSlcbiAgICAgICAgICAgIC5maWx0ZXIoKFtuYW1lLCB2ZXJzaW9uXSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjdXIgPSBtdi5nZXQobmFtZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1ciA/IGN1ciAhPT0gdmVyc2lvbiA6IHRydWU7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm1hcCgoW25hbWUsIHZlcnNpb25dKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGN1ciA9IG12LmdldChuYW1lKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gW25hbWUsIGN1ciB8fCB2ZXJzaW9uLCB2ZXJzaW9uLCB1bmRlZmluZWQsIFwic2hhZG93XCJdO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5maWx0ZXIodiA9PiBuYW1lcy5oYXModlswXSkgPT09IGZhbHNlKTtcbiAgICAgICAgcmV0dXJuIGRpZmYuY29uY2F0KHNoYWRvd3Muc29ydCgobGVmdCwgcmlnaHQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBsZWZ0WzBdLmxvY2FsZUNvbXBhcmUocmlnaHRbMF0pO1xuICAgICAgICB9KSk7XG4gICAgfVxuICAgIHJldHVybiBkaWZmO1xufVxuXG5mdW5jdGlvbiBmaW5kRXhpc3RpbmdCcmFuY2goTE9HLCBvcHRpb25zLCBuYW1lcywgZGlmZiwgaGV4KSB7XG4gICAgTE9HKFwiRmluZCBleGlzdGluZyBicmFuY2guXCIpO1xuICAgIGxldCBuZXdCcmFuY2ggPSBgJHtvcHRpb25zLnByZWZpeH0ke29wdGlvbnMubm93fS8ke2hleH1gO1xuICAgIGxldCBmb3VuZCA9IG5hbWVzLmZpbmQobiA9PiBuLmVuZHNXaXRoKGhleCkpO1xuICAgIGlmIChmb3VuZCkge1xuICAgICAgICBMT0coYEZvdW5kIGV4aXN0aW5nIGJyYW5jaCAke2ZvdW5kfWApO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoXCJXb3JraW5nIEJyYW5jaCBpcyBhbHJlYWR5IGV4aXN0cy5cIik7XG4gICAgfVxuICAgIHJldHVybiBbbmV3QnJhbmNoLCBkaWZmXTtcbn1cblxuZnVuY3Rpb24gYWRkVGFyZ2V0RmlsZXMoTE9HLCBvcHRpb25zLCBnaXQpIHtcbiAgICBsZXQgdGFyZ2V0cyA9IFtdO1xuICAgIGlmIChvcHRpb25zLmxhdGVzdCkge1xuICAgICAgICBMT0coXCJBZGRlZCBwYWNrYWdlLmpzb24gaW50byByZXF1ZXN0IGZpbGVzIGJlY2F1c2UgLS1sYXRlc3QgaXMgc3BlY2lmaWVkLlwiKTtcbiAgICAgICAgdGFyZ2V0cy5wdXNoKFwicGFja2FnZS5qc29uXCIpO1xuICAgIH1cbiAgICB0YXJnZXRzLnB1c2goXCJ5YXJuLmxvY2tcIik7XG4gICAgcmV0dXJuIHRhcmdldHMucmVkdWNlKFxuICAgICAgICAocHJvbWlzZSwgdGFyZ2V0KSA9PiBwcm9taXNlLnRoZW4oKCkgPT4gZ2l0LmFkZCh0YXJnZXQpKSxcbiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKClcbiAgICApO1xufVxuXG5mdW5jdGlvbiBzZWxlY3RQdXNoUHJvbWlzZShMT0csIG9wdGlvbnMsIGdpdCwgcmVtb3RlLCBicmFuY2gpIHtcbiAgICBpZiAob3B0aW9ucy5leGVjdXRlKSB7XG4gICAgICAgIHJldHVybiBnaXQucHVzaChyZW1vdGUsIGJyYW5jaCk7XG4gICAgfVxuICAgIExPRyhcImBnaXQgcHVzaGAgaXMgc2tpcHBlZCBiZWNhdXNlIC0tZXhlY3V0ZSBpcyBub3Qgc3BlY2lmaWVkLlwiKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG59XG5cbmZ1bmN0aW9uIHNlbGVjdERlbGV0ZVByb21pc2UoTE9HLCBvcHRpb25zLCBnaXQsIGJyYW5jaCwgcmVwb3J0KSB7XG4gICAgbGV0IHA7XG4gICAgaWYgKG9wdGlvbnMua2VlcCkge1xuICAgICAgICBMT0coXCJXb3JraW5nIGJyYW5jaCBpcyBrZXB0LlwiKTtcbiAgICAgICAgcCA9IFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIExPRyhcIkRlbGV0ZSB3b3JraW5nIGJyYW5jaCBiZWNhdXNlIC0ta2VlcCBpcyBub3Qgc3BlY2lmaWVkLlwiKTtcbiAgICAgICAgcCA9IGdpdC5kZWxldGVCcmFuY2goYnJhbmNoKTtcbiAgICB9XG4gICAgcmV0dXJuIHAudGhlbigoKSA9PiByZXBvcnQpO1xufVxuXG4vLyBmb3IgdGVzaW5nIHB1cnBvc2VcbmV4cG9ydCBjb25zdCBfX3Rlc3RfXyA9IFtmaW5kT3V0ZGF0ZWREZXBzLCBmaW5kRXhpc3RpbmdCcmFuY2gsIGFkZFRhcmdldEZpbGVzLCBzZWxlY3RQdXNoUHJvbWlzZSwgc2VsZWN0RGVsZXRlUHJvbWlzZV07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgbGV0IExPRyA9IG9wdGlvbnMubG9nZ2VyO1xuICAgIGxldCB5YXJucGtnID0gbmV3IFlhcm5wa2cob3B0aW9ucy53b3JraW5nZGlyLCBMT0cpO1xuICAgIGxldCBnaXQgPSBuZXcgR2l0KG9wdGlvbnMud29ya2luZ2RpciwgTE9HKTtcbiAgICByZXR1cm4geWFybnBrZy5pbnN0YWxsKClcbiAgICAgICAgLnRoZW4oKCkgPT4geWFybnBrZy5vdXRkYXRlZCgpKVxuICAgICAgICAudGhlbihvdXQgPT4gZmluZE91dGRhdGVkRGVwcyhMT0csIG91dCkpXG4gICAgICAgIC50aGVuKChbZGlmZiwgaGV4XSkgPT4gZ2l0LmZldGNoKFwib3JpZ2luXCIpLnRoZW4oKCkgPT4gW2RpZmYsIGhleF0pKVxuICAgICAgICAudGhlbigoW2RpZmYsIGhleF0pID0+IGdpdC5icmFuY2hMaXN0KCkudGhlbihuYW1lcyA9PiBbbmFtZXMsIGRpZmYsIGhleF0pKVxuICAgICAgICAudGhlbigoW25hbWVzLCBkaWZmLCBoZXhdKSA9PiBmaW5kRXhpc3RpbmdCcmFuY2goTE9HLCBvcHRpb25zLCBuYW1lcywgZGlmZiwgaGV4KSlcbiAgICAgICAgLnRoZW4oKFtuZXdCcmFuY2gsIGRpZmZdKSA9PiBnaXQuY2hlY2tvdXRXaXRoKG5ld0JyYW5jaCkudGhlbigoKSA9PiBkaWZmKSlcbiAgICAgICAgLnRoZW4oZGlmZiA9PiBjb2xsZWN0TW9kdWxlVmVyc2lvbnMob3B0aW9ucykudGhlbihtdiA9PiBbbXYsIGRpZmZdKSlcbiAgICAgICAgLnRoZW4oKFttdiwgZGlmZl0pID0+IHlhcm5wa2cudXBncmFkZShvcHRpb25zLmxhdGVzdCkudGhlbihvdXQgPT4gY29tcHV0ZVVwZGF0ZWREZXBlbmRlbmNpZXMoTE9HLCBvcHRpb25zLCBkaWZmLCBtdiwgb3V0KSkpXG4gICAgICAgIC50aGVuKGRpZmYgPT4gZ2l0LnNldHVwKG9wdGlvbnMudXNlcm5hbWUsIG9wdGlvbnMudXNlcmVtYWlsKS50aGVuKCgpID0+IFtkaWZmLCBvcHRpb25zXSkpXG4gICAgICAgIC50aGVuKChbZGlmZiwgb3B0aW9uc10pID0+IGFkZFRhcmdldEZpbGVzKExPRywgb3B0aW9ucywgZ2l0KS50aGVuKCgpID0+IGRpZmYpKVxuICAgICAgICAudGhlbihkaWZmID0+IGdpdC5jb21taXQoXCJ1cGRhdGUgZGVwZW5kZW5jaWVzXCIpLnRoZW4oKCkgPT4gZGlmZikpXG4gICAgICAgIC50aGVuKGRpZmYgPT4gZ2l0LmN1cnJlbnRCcmFuY2goKS50aGVuKG5ld0JyYW5jaCA9PiBbbmV3QnJhbmNoLCBkaWZmXSkpXG4gICAgICAgIC50aGVuKChbbmV3QnJhbmNoLCBkaWZmXSkgPT4gZ2l0LmNoZWNrb3V0KFwiLVwiKS50aGVuKCgpID0+IChbbmV3QnJhbmNoLCBkaWZmXSkpKVxuICAgICAgICAudGhlbigoW25ld0JyYW5jaCwgZGlmZl0pID0+IGdpdC5jdXJyZW50QnJhbmNoKCkudGhlbihiYXNlQnJhbmNoID0+IFtiYXNlQnJhbmNoLCBuZXdCcmFuY2gsIGRpZmZdKSlcbiAgICAgICAgLnRoZW4oKFtiYXNlQnJhbmNoLCBuZXdCcmFuY2gsIGRpZmZdKSA9PlxuICAgICAgICAgICAgc2VsZWN0UHVzaFByb21pc2UoTE9HLCBvcHRpb25zLCBnaXQsIFwib3JpZ2luXCIsIG5ld0JyYW5jaClcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiBbYmFzZUJyYW5jaCwgbmV3QnJhbmNoLCBkaWZmXSkpXG4gICAgICAgIC50aGVuKChbYmFzZUJyYW5jaCwgbmV3QnJhbmNoLCBkaWZmXSkgPT4gZ2l0LnJlbW90ZXVybChcIm9yaWdpblwiKVxuICAgICAgICAgICAgLnRoZW4ocmVtb3RlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5iaXRidWNrZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtuZXcgQml0QnVja2V0KG9wdGlvbnMsIHJlbW90ZSksIGJhc2VCcmFuY2gsIG5ld0JyYW5jaCwgZGlmZl07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtuZXcgR2l0SHViKG9wdGlvbnMsIHJlbW90ZSksIGJhc2VCcmFuY2gsIG5ld0JyYW5jaCwgZGlmZl07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkpXG4gICAgICAgIC50aGVuKChbZ2l0aHViLCBiYXNlQnJhbmNoLCBuZXdCcmFuY2gsIGRpZmZdKSA9PlxuICAgICAgICAgICAgZ2l0aHViLnB1bGxSZXF1ZXN0KGJhc2VCcmFuY2gsIG5ld0JyYW5jaCwgZGlmZilcbiAgICAgICAgICAgICAgICAudGhlbihyZXBvcnQgPT4gW3JlcG9ydCwgbmV3QnJhbmNoXSkpXG4gICAgICAgIC50aGVuKChbcmVwb3J0LCBuZXdCcmFuY2hdKSA9PlxuICAgICAgICAgICAgc2VsZWN0RGVsZXRlUHJvbWlzZShMT0csIG9wdGlvbnMsIGdpdCwgbmV3QnJhbmNoLCByZXBvcnQpKTtcbn1cbiJdfQ==